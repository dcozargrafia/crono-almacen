generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User roles
enum Role {
  USER
  ADMIN
}

// Device manufacturing and operational status
enum DeviceModel {
  TSONE
  TS2
  TS2_PLUS  // TS2+ (Prisma doesn't allow + in names)
  CLB
}

enum ManufactoringStatus {
  PENDING           // Not started
  IN_PROGRESS       // Being manufactured
  PHASE1_COMPLETED  // First phase done
  AWAITING_QA       // Waiting for quality check
  COMPLETED         // Finished
  OUT_OF_STOCK      // Missing parts
}

enum OperationalStatus {
  IN_MANUFACTURING  // Still being built
  AVAILABLE         // Ready to rent/sell
  RENTED            // Currently rented
  SOLD              // Sold to client
  IN_REPAIR         // Under maintenance
  RETIRED           // No longer in use
}

enum FrequencyRegion {
  EU
  FCC
  GX1
  GX2
}

// System user with JWT authentication
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String   // bcrypt hash (10 rounds)
  name      String
  role      Role     @default(USER)
  active    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

// Client that owns or rents devices
model Client {
  id               Int      @id @default(autoincrement())
  name             String
  codeSportmaniacs Int?  @unique  // ID in Sportmaniacs platform
  email            String?
  active           Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  devices Device[]
  rentals Rental[]

  @@map("clients")
}

// Timing device manufactured in-house
model Device {
  id Int @id @default(autoincrement())

  // Identification (required)
  model             DeviceModel
  manufactoringCode String      @unique  // Assigned at start of manufacturing

  // Status (required with defaults)
  manufactoringStatus ManufactoringStatus @default(PENDING)
  operationalStatus   OperationalStatus   @default(IN_MANUFACTURING)
  availableForRental  Boolean             @default(false)

  // Owner - Client who owns the device (optional until sold)
  ownerId Int?
  owner   Client? @relation(fields: [ownerId], references: [id], onDelete: SetNull)

  // Additional identification (optional)
  serialNumber String? @unique  // Assigned when sold, format varies
  portCount    Int?             // Number of ports (for TS2, TS2+)

  // Regional configuration (optional)
  frequencyRegion FrequencyRegion?

  // Metadata (optional)
  manufacturingDate DateTime?
  notes             String?

  // TSONE/TS2/TS2+ specific fields (optional)
  reader1SerialNumber String?
  reader2SerialNumber String?
  cpuSerialNumber     String?
  batterySerialNumber String?
  tsPowerModel        String?
  cpuFirmware         String?
  gx1ReadersRegion    String?
  hasGSM              Boolean?
  hasGUN              Boolean?

  // CLB specific fields (optional)
  bluetoothAdapter String?
  coreVersion      String?
  heatsinks        String?
  picVersion       String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  rentalDevices RentalDevice[]

  // Indexes
  @@index([model])
  @@index([manufactoringStatus])
  @@index([operationalStatus])
  @@index([availableForRental])

  @@map("devices")
}

// Product types for rental equipment
enum ProductType {
  ANTENNA
  STOPWATCH
  PHONE
  MIFI
  CABLE
  OTHER
}

// Product unit status (for serialized items)
enum ProductUnitStatus {
  AVAILABLE
  RENTED
  IN_REPAIR
  RETIRED
}

// Rental status
enum RentalStatus {
  ACTIVE     // In progress
  RETURNED   // All items returned
  CANCELLED  // Cancelled (inventory restored)
}

// Rental products tracked by quantity (antennas, cables, etc.)
model Product {
  id          Int         @id @default(autoincrement())
  name        String
  type        ProductType
  description String?
  notes       String?

  // Quantity tracking
  totalQuantity     Int @default(0)
  availableQuantity Int @default(0)
  rentedQuantity    Int @default(0)
  inRepairQuantity  Int @default(0)

  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  rentalProducts RentalProduct[]

  @@index([type])
  @@index([active])

  @@map("products")
}

// Serialized product units (stopwatches, phones, mifi)
model ProductUnit {
  id           Int               @id @default(autoincrement())
  type         ProductType
  serialNumber String            @unique
  notes        String?
  status       ProductUnitStatus @default(AVAILABLE)

  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  rentalProductUnits RentalProductUnit[]

  @@index([type])
  @@index([status])
  @@index([active])

  @@map("product_units")
}

// Rental transaction
model Rental {
  id              Int          @id @default(autoincrement())
  clientId        Int
  client          Client       @relation(fields: [clientId], references: [id])

  startDate       DateTime
  expectedEndDate DateTime
  actualEndDate   DateTime?    // Filled when returned

  status          RentalStatus @default(ACTIVE)
  notes           String?

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Rented items
  devices      RentalDevice[]
  products     RentalProduct[]
  productUnits RentalProductUnit[]

  @@index([clientId])
  @@index([status])
  @@index([startDate])

  @@map("rentals")
}

// Devices in a rental
model RentalDevice {
  id       Int    @id @default(autoincrement())
  rentalId Int
  rental   Rental @relation(fields: [rentalId], references: [id], onDelete: Cascade)
  deviceId Int
  device   Device @relation(fields: [deviceId], references: [id])

  @@unique([rentalId, deviceId])
  @@map("rental_devices")
}

// Products (quantity-based) in a rental
model RentalProduct {
  id        Int     @id @default(autoincrement())
  rentalId  Int
  rental    Rental  @relation(fields: [rentalId], references: [id], onDelete: Cascade)
  productId Int
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int

  @@unique([rentalId, productId])
  @@map("rental_products")
}

// ProductUnits (serial-based) in a rental
model RentalProductUnit {
  id            Int         @id @default(autoincrement())
  rentalId      Int
  rental        Rental      @relation(fields: [rentalId], references: [id], onDelete: Cascade)
  productUnitId Int
  productUnit   ProductUnit @relation(fields: [productUnitId], references: [id])

  @@unique([rentalId, productUnitId])
  @@map("rental_product_units")
}
